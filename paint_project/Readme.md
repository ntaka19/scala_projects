# 課題の内容

同梱のtechdraw.scalaを参考にし，描画エディタとして完成度を高めること．

# 基本機能（必須）

- 配布したプログラムは線の色と塗り潰しの色を指定するためのツールがあります．矩形（長方形）を描画したときには矩形内が塗り潰し色で着色されるようになっていますが，線の色は反映されていません．線の色が反映されるように修正して下さい．

- 未実装の図形ツールを完成して下さい．矩形ツールの実装が参考になることでしょう．

    - 楕円("Ellipse" tool)

    - 線("Line" tool)

    この課題に取り組んでいるうちに，楕円と線の機能を実装するコードは，矩形の実装コードとかなりの類似することに気づくと思います．類似したコードを共通化することでコード量の削減を達成した場合には加点として評価します．

- 選択ツールの実装に複数のバグがあるようです．注意深く観察して問題点を見つけ，適切に修正しなさい．

    線分の選択判定については困るかもしれませんね．選択ツールの実装において，ポインタが矩形内部にあるか否かの判定にRectangleクラスの`r.contains(x, y)`というメソッドを利用しています．しかし，線分を表現しているLineクラスはcontainsメソッドを提供していません．（数学的には線分は太さを持っていないからです）実用的にはクリックした周辺に線分があるか否かを判定することになります．このためにクリックした位置を中心にした小さな正方形領域を作成し，その領域と線分が交差するかを判定することが考えられます．Lineクラスのintersectsメソッドが気になることでしょう．

- 選択ツールによって指定された図形には影がつくようになっています．でも，いったんついた影がその後も残ってしまいます．この点を修正しなさい．なおshapeという変数で参照される図形ついた陰を除去するには`shape.effect = null`と代入すればよいです．問題はいつ，どの図形についで，この代入を施すかということです．

- 選択ツールを用いて選択された矩形の塗り潰し色を塗り潰し色ツールを用いて変更することができることを確認しなさい．線の色も同様の方法で変更できるように修正しなさい．

    - 楕円と線分についても塗り潰し色と線の色を変更できるように修正しなさい．

- 選択ツールを用いて図形をドラッグしたときに，指定された図形が移動するように修正しなさい．選択ツールを用いて図形の縁をドラッグしたときに，指定された図形を拡大・縮小できるように修正しなさい．

    ここで実装した図形の形状の編集中に誤って，図形をとても小さく変形させてしまうことがあります．このような場合，その図形を選択したり，ドラッグして移動することが難しくなるかもしれません．この点について工夫をしている場合には加点として評価します．

- すでに描画されている図形を削除する機能を追加しなさい．選択ツールを用いて図形を選択したのちに，キーボードのDeleteキーを使って図形を削除できるようにしなさい．

# 追加が望ましい機能（中級）

- **図形の表示順を変更する機能**: 図形を選択しているときに，キーボードの↑キーを打つとモデル内での図形群の順序を変更して，当該図形がより手前に表示されるようにして下さい．

    素朴な実装は当該図形をBuffer内の隣接図形と位置を交換すればいいでしょう．実際，このような手法は，市販の描画エディタの実装とも近いようです．ただ，この方法では，Buffer内の隣接した図形と当該図形に重なりがない場合に，表示順の変化が画面の変化として見えなくて残念です．
    たとえば，Bufferの状態が[ _, _, A, a, b, c, B, _, _ ]だったときにAが選択されていることにしましょう．さらにAはa, b, cとは重なっておらず，Bと重なっていることとします．このとき，画面表示ではAは部分的にBに隠されているはずです．
    
    ここで↑を押すことについて考えます．素朴な[ _, _, a, A, b, c, B, _, _ ]と変化しますが，aは元々，Aを隠していないので，画面にはBufferの変化が伝わりません．さらに三回↑を押すとようやくBufferは[ _, _, a, b, c, B, A, _, _ ]と変化し，Aの領域のうちBによって隠されていた部分が露出することになります．

    この考察を参考に，↑を押したときに画面変化が起きるようにBufferを変化させる工夫を施している場合には加点として評価します．↓についても同様です．

    多くの描画エディタは選択した図形を前後に移動するだけでなく，一番手前や一番奥に移動する機能も提供します．Shift+↑，Shift+↓を用いて実現するとよいでしょう．

- **複数の図形の選択**: もともとの実装では，ひとつの図形しか選択できません．一般的な描画ツールは複数の図形を選択するための手段をいくつか提供しています．

    - 選択ツールを利用しているときにシフトキーを押しながらクリックすると選択している図形の集合へ図形を追加できる．また，すでに選択状態にある図形をクリックするとその図形は非選択状態に戻る．(PowerPoint, OmniGraffle)

    - 選択ツールを利用しているときにドラッグをすると
        - ドラッグした領域に包含された図形が選択される(OmniGraffle)
        - ドラッグした領域に包含，あるいは交差する図形が選択される(PowerPoint)

    複数の図形を選択できるように機能拡張をしなさい．また，複数選択された図形に対しての以下の操作を実装しなさい．
    
    - 選択された図形群のうちのひとつをドラッグすることで，選択された図形群をまとめて移動する機能
    - 図形群が選択されているときに，塗り潰し色や縁取り色をまとめて変更する機能
    - 図形群をまとめて削除する機能

- **折れ線，多角形**: 折れ線や多角形を描画する機能を追加しなさい．折れ線の場合は，折れ線ツールを追加し，クリック，クリック，...，クリック，ダブルクリックというダブルクリックで終わる操作列によって形状を指定することができるでしょう．ダブルクリックの実装方法については，[この記事のコード](https://kwakita.wordpress.com/2015/01/29/scala-scalafx-でダブルクリック，トリプルクリックを検知/)を参考にして下さい．

- **図形を上下左右に反転させる機能**: 選択ツールを利用しているときに上下反転ツール，あるいは左右反転ツールを利用して反転できる機能を追加すること．

    この機能を素朴に実装すると，図形の描画機能と類似したコードになりそうです．これらの類似性を解消して，簡潔なコードで記述できた場合には加点として評価します．

    複数選択された図形群に対応した場合には加点として評価します．

- **折れ線，多角形**の変形機能: 選択ツールを利用しているときに，すでに描画された折れ線をダブルクリックするとその図形の変形モードにはいり，図形を構成している点をドラッグによって移動することで図形を変形できるようにする機能．図形外の点がクリックされた時点で図形の変形モードを脱して，通常の選択モードに移るとよいでしょう．

    ドラッグ開始点が図形を構成する点に隣接するか否かについて判定するのは案外簡単です．ドラッグ開始点を囲う小さな正方形を考えて，それが点を包含するか否かを正方形のcontainsメソッドを用いて判定できるからです．

# 自由拡張

基本機能を完全に実装した場合を100点とします．計算機科学第一の全体の成績に対する重みは30%（つまり30点分）とします．

追加が望ましい機能を実装した場合，それぞれの機能について10点ずつを加点します．

基本機能，および追加が望ましい機能の説明中の加点に関わる機能を実装している場合は，それぞれ10点ずつを加点します．

上述の拡張に留まらず，好きな機能をどんどん追加して下さい．追加した機能に応じて10点ずつ加点として評価します．

加点は最大で100点までとします．つまり，この課題に一生懸命取り組んだ方のこの課題の成績は200点となります．これは計算機科学第一の全体の成績に反映すると60点分となります．これまでの課題の内容に自信がない人も大いにがんばって下さい．

# 提出物と提出期限

2/15を提出期限とします．それより遅れると採点が間に合いません．期限厳守でお願いします．

src/techdraw.scalaとreport.pdfを提出しなさい．report.pdfは同梱のreport.texを用いて作成して下さい．pLaTeXの使い方はコンピュータリテラシで学びましたよね？

# 評価基準

このレポートの配点の重みはこの科目全体の30%とします．きちんと取り組めば，よい成績につながります．がんばって下さい．

# 課題の内容についての質問

課題の内容についての質問はこのプロジェクトのGit Issuesでお願いします．

# ScalaFX について

- [本家](http://www.scalafx.org)
- [概要の説明](http://www.scalafx.org/docs/home/)
- [豊富なデモプログラム](https://github.com/scalafx/scalafx/tree/master/scalafx-demos/src/main/scala/scalafx) --- [scalafxプロジェクト](https://github.com/scalafx/scalafx.git)をチェックアウトして，`scalafx/scalafx/src/main/scala/scalafx`のなかを探ると参考になるコードがたくさん見つかります．
- ScalaFXのマニュアル
    - [ScalaFX 2.2 API](http://www.scalafx.org/api/2.2/index.html)
    - [ScalaFX 8.0 API](http://www.scalafx.org/api/8.0/index.html)
    ScalaFXには8.0系と2.2系の二系統があります．今学期の最初の講義で紹介したように，ScalaはJavaというほかのプログラミングシステムへの変換器として実装されています．そのため，ScalaFXもJavaの機能に依存しています．ScalaFXの開発は主に8.0系で進んでいるのですが，この系列依存しているJava 8は演習棟のMacでは動作しません．一方，みなさんのお持ちのパソコンにはJava 8が動作するためScalaFX 8.0を利用することができます．

    このようなややこしい状況に対応するために，この授業でのScalaFXの設定では，インストールされているJavaのバージョンに応じて，利用するScalaFXのバージョンを適応的に選択するように設定しています．設定ファイルは`project/Build.scala`です．基本的に，ScalaFX 8.0はScalaFX 2.2の拡張として実装されています．このため，ScalaFX 2.2のAPIに沿ってプログラムを作成すれば，どこの環境でも動くことでしょう．
